---
import Layout from '../layouts/Layout.astro';
import { auth } from "../utils/auth";

const authInstance = await auth(Astro.locals.runtime.env);

const session = await authInstance.api.getSession({
  headers: Astro.request.headers,
});
console.log("session", session);

// Redirect if already authenticated
if (session) {
  return Astro.redirect(import.meta.env.BASE_URL + "/");
}
---

<Layout>
  <div class="min-h-screen bg-base-200 flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-md w-full">
      <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
          <!-- Header -->
          <div class="text-center mb-8">
            <h2 class="card-title text-3xl font-bold justify-center bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">
              Create your account
            </h2>
            <p class="text-base-content/70 mt-2">
              Or 
              <a
                href={import.meta.env.BASE_URL + "/login"}
                class="link link-primary font-medium"
              >
                sign in to your existing account
              </a>
            </p>
          </div>
          
          <!-- Signup Form -->
          <form id="signupForm" class="space-y-6" method="POST">
            <div class="space-y-4">
              <div class="form-control">
                <label for="name" class="label">
                  <span class="label-text">Full name</span>
                </label>
                <input
                  id="name"
                  name="name"
                  type="text"
                  autocomplete="name"
                  required
                  class="input input-bordered w-full"
                  placeholder="Enter your full name"
                />
              </div>
              
              <div class="form-control">
                <label for="email" class="label">
                  <span class="label-text">Email address</span>
                </label>
                <input
                  id="email"
                  name="email"
                  type="email"
                  autocomplete="email"
                  required
                  class="input input-bordered w-full"
                  placeholder="Enter your email address"
                />
              </div>
              
              <div class="form-control">
                <label for="password" class="label">
                  <span class="label-text">Password</span>
                </label>
                <input
                  id="password"
                  name="password"
                  type="password"
                  autocomplete="new-password"
                  required
                  minlength="8"
                  class="input input-bordered w-full"
                  placeholder="Enter your password (min 8 characters)"
                />
                <label class="label">
                  <span class="label-text-alt text-base-content/60">Minimum 8 characters required</span>
                </label>
              </div>
            </div>

            <!-- Error Message -->
            <div id="error" class="alert alert-error hidden">
              <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span id="error-text"></span>
            </div>

            <!-- Submit Button -->
            <div class="form-control mt-6">
              <button
                type="submit"
                id="submitBtn"
                class="btn btn-primary w-full"
              >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                </svg>
                Create account
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  import { authClient } from "../utils/auth-client";

  const form = document.getElementById('signupForm') as HTMLFormElement;
  const submitBtn = document.getElementById('submitBtn') as HTMLButtonElement;
  const errorDiv = document.getElementById('error') as HTMLDivElement;
  const errorText = document.getElementById('error-text') as HTMLSpanElement;

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(form);
    const email = formData.get('email') as string;
    const password = formData.get('password') as string;
    const name = formData.get('name') as string;

    // Show loading state
    submitBtn.disabled = true;
    submitBtn.innerHTML = `
      <span class="loading loading-spinner loading-sm"></span>
      Creating account...
    `;
    errorDiv.classList.add('hidden');

    try {
      const { data, error } = await authClient.signUp.email({
        email,
        password,
        name,
      });

      if (error) {
        errorText.textContent = error.message || 'Signup failed';
        errorDiv.classList.remove('hidden');
      } else if (data) {
        // Redirect on success
        window.location.href = import.meta.env.BASE_URL + '/';
      }
    } catch (err) {
      errorText.textContent = 'An unexpected error occurred';
      errorDiv.classList.remove('hidden');
    } finally {
      // Reset loading state
      submitBtn.disabled = false;
      submitBtn.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
        </svg>
        Create account
      `;
    }
  });
</script>
