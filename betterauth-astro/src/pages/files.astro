---
import Layout from '../layouts/Layout.astro';
import { auth } from '../utils/auth';

// Check authentication
const authInstance = await auth(Astro.locals.runtime.env);
const session = await authInstance.api.getSession({
  headers: Astro.request.headers,
});

if (!session?.user) {
  return Astro.redirect('/login');
}
---

<!-- Import Uppy CSS -->
<link href="https://releases.transloadit.com/uppy/v3.21.0/uppy.min.css" rel="stylesheet">

<Layout title="File Manager">
  <div class="min-h-screen bg-gray-50 py-12 px-4">
    <div class="max-w-6xl mx-auto">
      <div class="bg-white rounded-lg shadow-md p-8">
        <h1 class="text-3xl font-bold text-center mb-8 bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent font-wf-visual-sans-semibold">
          File Manager
        </h1>
        <p class="text-center text-gray-600 mb-8">
          Upload and manage your files for use in Webflow sites
        </p>

        <!-- Status Message -->
        <div id="statusMessage" class="hidden p-4 mb-6 rounded-md"></div>

        <!-- Upload Section -->
        <div class="mb-8">
          <h2 class="text-xl font-semibold mb-4">Upload New File</h2>
          <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 bg-gray-50">
            <!-- Uppy Dashboard -->
            <div id="uppy-dashboard"></div>
            
            <!-- Uppy Progress Bar -->
            <div id="uppy-progress" class="mt-4"></div>
          </div>
        </div>

        <!-- Files List -->
        <div>
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-semibold">Your Files</h2>
            <div class="flex items-center gap-4">
              <!-- View Mode Toggle -->
              <div class="flex items-center bg-gray-100 rounded-lg p-1">
                <button
                  id="tableViewBtn"
                  class="px-3 py-1 text-sm rounded-md transition-colors"
                  onclick="switchViewMode('table')"
                >
                  üìã Table
                </button>
                <button
                  id="gridViewBtn"
                  class="px-3 py-1 text-sm rounded-md transition-colors"
                  onclick="switchViewMode('grid')"
                >
                  üñºÔ∏è Grid
                </button>
              </div>
            </div>
          </div>

          <!-- Batch Actions (hidden by default) -->
          <div id="batchActions" class="hidden mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-4">
                <span id="selectedCount" class="text-sm font-medium text-blue-800">0 files selected</span>
                <button
                  onclick="selectAllFiles()"
                  class="text-sm text-blue-600 hover:text-blue-800 underline"
                >
                  Select All
                </button>
                <button
                  onclick="deselectAllFiles()"
                  class="text-sm text-blue-600 hover:text-blue-800 underline"
                >
                  Deselect All
                </button>
              </div>
              <button
                onclick="deleteSelectedFiles()"
                class="px-4 py-2 bg-red-600 text-white text-sm rounded-md hover:bg-red-700 transition-colors"
              >
                üóëÔ∏è Delete Selected
              </button>
            </div>
          </div>

          <div id="filesList">
            <div class="text-center py-12 text-gray-500">
              <div class="text-4xl mb-4">üìÇ</div>
              <p>Loading files...</p>
              <div class="mt-4">
                <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Back Button -->
        <div class="mt-8 text-center">
          <a
            href={import.meta.env.BASE_URL + "/"}
            class="bg-gray-600 text-white px-6 py-3 rounded-md font-medium hover:bg-gray-700 transition-colors inline-block"
          >
            Back to Home
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Video Player Modal -->
  <div id="videoModal" class="fixed inset-0 bg-black bg-opacity-75 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg max-w-4xl w-full max-h-full overflow-hidden">
      <div class="flex items-center justify-between p-4 border-b">
        <h3 id="videoTitle" class="text-lg font-semibold text-gray-900 truncate"></h3>
        <button
          onclick="closeVideoModal()"
          class="text-gray-400 hover:text-gray-600 text-2xl font-bold"
        >
          √ó
        </button>
      </div>
      <div class="p-4">
        <video
          id="videoPlayer"
          controls
          class="w-full h-auto max-h-[70vh] rounded"
          preload="metadata"
        >
          Your browser does not support the video tag.
        </video>
      </div>
    </div>
  </div>
</Layout>

<style>
  /* Custom Uppy styling to match your design */
  .uppy-Dashboard {
    border: none !important;
    border-radius: 0.5rem !important;
    box-shadow: none !important;
  }

  .uppy-Dashboard-inner {
    border: none !important;
    border-radius: 0.5rem !important;
  }

  .uppy-Dashboard-dropzone {
    border: 2px dashed #d1d5db !important;
    border-radius: 0.5rem !important;
    background-color: #f9fafb !important;
  }

  .uppy-Dashboard-dropzone.is-dragenter {
    border-color: #3b82f6 !important;
    background-color: #eff6ff !important;
  }

  .uppy-Dashboard-AddFiles {
    background-color: transparent !important;
    border: none !important;
    color: #6b7280 !important;
  }

  .uppy-Dashboard-AddFiles:hover {
    background-color: transparent !important;
    color: #374151 !important;
  }

  .uppy-ProgressBar {
    border-radius: 0.5rem !important;
    background-color: #e5e7eb !important;
  }

  .uppy-ProgressBar-bar {
    background-color: #3b82f6 !important;
    border-radius: 0.5rem !important;
  }

  .uppy-Dashboard-Item {
    border-radius: 0.5rem !important;
    border: 1px solid #e5e7eb !important;
  }

  .uppy-Dashboard-Item-preview {
    border-radius: 0.5rem !important;
  }
</style>

<script>
  import { uppyR2S3Uploader } from '../utils/uppy-r2-s3';
  import Dashboard from '@uppy/dashboard';
  import ProgressBar from '@uppy/progress-bar';
  import {
    listFiles,
    deleteFile,
    getFileTypeCategory,
    formatFileSize,
    getFileIcon,
  } from '../utils/file-api.js';

  // DOM elements
  const statusMessage = document.getElementById('statusMessage') as HTMLElement;
  const filesList = document.getElementById('filesList') as HTMLElement;
  const batchActions = document.getElementById('batchActions') as HTMLElement;
  const selectedCount = document.getElementById('selectedCount') as HTMLElement;
  const tableViewBtn = document.getElementById('tableViewBtn') as HTMLElement;
  const gridViewBtn = document.getElementById('gridViewBtn') as HTMLElement;
  const videoModal = document.getElementById('videoModal') as HTMLElement;
  const videoPlayer = document.getElementById('videoPlayer') as HTMLVideoElement;
  const videoTitle = document.getElementById('videoTitle') as HTMLElement;

  // State management
  let currentFiles: any[] = [];
  let selectedFiles = new Set<string>();
  let currentViewMode = 'grid'; // 'grid' or 'table'

  // Initialize Uppy with R2 S3 support
  const uppy = uppyR2S3Uploader.getUppy();

  // Add Dashboard plugin
  uppy.use(Dashboard, {
    inline: true,
    target: '#uppy-dashboard',
    height: 300,
    showProgressDetails: true,
    proudlyDisplayPoweredByUppy: false,
    theme: 'light',
    width: '100%',
  });

  // Add Progress Bar plugin
  uppy.use(ProgressBar, {
    target: '#uppy-progress',
    hideAfterFinish: true, // Hide after finish to avoid duplicate
  });

  // Initialize
  loadFiles();

  // Get base URL for navigation
  const baseUrl = import.meta.env.BASE_URL;

  function showStatus(text: string, type: 'success' | 'error' | 'info') {
    if (!statusMessage) return;
    
    statusMessage.textContent = text;
    statusMessage.className = `p-4 mb-6 rounded-md ${
      type === 'success'
        ? 'bg-green-100 text-green-700 border border-green-200'
        : type === 'error'
        ? 'bg-red-100 text-red-700 border border-red-200'
        : 'bg-blue-100 text-blue-700 border border-blue-200'
    }`;
    statusMessage.classList.remove('hidden');
    
    setTimeout(() => {
      statusMessage.classList.add('hidden');
    }, 5000);
  }

  async function loadFiles() {
    try {
      const response = await listFiles();
      if (response.success && response.files) {
        currentFiles = response.files;
        renderFiles(currentFiles);
      } else {
        showStatus(response.error || 'Failed to load files', 'error');
        renderEmptyState();
      }
    } catch (error) {
      showStatus('Failed to load files', 'error');
      renderEmptyState();
    }
  }

  function renderFiles(files: any[]) {
    if (!filesList) return;

    if (files.length === 0) {
      renderEmptyState();
      return;
    }

    if (currentViewMode === 'table') {
      renderTableView(files);
    } else {
      renderGridView(files);
    }
  }

  function renderTableView(files: any[]) {
    const filesHtml = files.map(file => `
      <tr class="border-b border-gray-200 hover:bg-gray-50">
        <td class="px-4 py-3">
          <input
            type="checkbox"
            class="file-checkbox rounded border-gray-300 text-blue-600 focus:ring-blue-500"
            data-key="${file.key}"
            ${selectedFiles.has(file.key) ? 'checked' : ''}
            onchange="toggleFileSelection('${file.key}')"
          />
        </td>
        <td class="px-4 py-3">
          <div class="flex items-center gap-3">
            <div class="text-2xl">${getFileIcon(file.contentType)}</div>
            <div>
              <div class="font-medium text-gray-900 truncate max-w-xs" title="${file.filename}">
                ${file.filename}
              </div>
              <div class="text-sm text-gray-500">${getFileTypeCategory(file.contentType)}</div>
            </div>
          </div>
        </td>
        <td class="px-4 py-3 text-sm text-gray-600">${formatFileSize(file.fileSize)}</td>
        <td class="px-4 py-3 text-sm text-gray-600">
          ${(() => {
            try {
              const date = new Date(file.uploadedAt);
              return isNaN(date.getTime()) 
                ? 'Recently' 
                : `${date.toLocaleDateString()} at ${date.toLocaleTimeString()}`;
            } catch (e) {
              return 'Recently';
            }
          })()}
        </td>
        <td class="px-4 py-3">
          <div class="flex gap-2">
            <button
              onclick="openFile('${file.url}', '${file.filename}', '${file.contentType}')"
              class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700"
            >
              ${file.contentType.startsWith('video/') ? 'Play' : 'Open'}
            </button>
            <button
              onclick="copyToClipboard('${file.url}')"
              class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300"
              id="copy-${file.key}"
            >
              Copy URL
            </button>
            <button
              onclick="handleDelete('${file.key}', '${file.filename}')"
              class="px-3 py-1 text-sm bg-red-600 text-white rounded hover:bg-red-700"
              id="delete-${file.key}"
            >
              Delete
            </button>
          </div>
        </td>
      </tr>
    `).join('');

    filesList.innerHTML = `
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                <input
                  type="checkbox"
                  class="select-all-checkbox rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                  onchange="toggleSelectAll(this)"
                />
              </th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">File</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Size</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Uploaded</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            ${filesHtml}
          </tbody>
        </table>
      </div>
    `;
  }

  function renderGridView(files: any[]) {
    const filesHtml = files.map(file => `
      <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
        <div class="flex items-start justify-between mb-3">
          <div class="flex items-center gap-2">
            <input
              type="checkbox"
              class="file-checkbox rounded border-gray-300 text-blue-600 focus:ring-blue-500"
              data-key="${file.key}"
              ${selectedFiles.has(file.key) ? 'checked' : ''}
              onchange="toggleFileSelection('${file.key}')"
            />
            <div class="text-2xl">${getFileIcon(file.contentType)}</div>
          </div>
          <button
            onclick="handleDelete('${file.key}', '${file.filename}')"
            class="text-red-500 hover:text-red-700 text-sm"
            id="delete-${file.key}"
          >
            Delete
          </button>
        </div>
        
        <h3 class="font-medium text-gray-900 mb-1 truncate" title="${file.filename}">
          ${file.filename}
        </h3>
        
        <p class="text-sm text-gray-600 mb-2">
          ${formatFileSize(file.fileSize)} ‚Ä¢ ${getFileTypeCategory(file.contentType)}
        </p>
        
        <p class="text-xs text-gray-500 mb-3">
          Uploaded ${(() => {
            try {
              const date = new Date(file.uploadedAt);
              return isNaN(date.getTime()) 
                ? 'Recently' 
                : `${date.toLocaleDateString()} at ${date.toLocaleTimeString()}`;
            } catch (e) {
              return 'Recently';
            }
          })()}
        </p>
        
        <div class="flex gap-2">
          <button
            onclick="openFile('${file.url}', '${file.filename}', '${file.contentType}')"
            class="flex-1 px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700"
          >
            ${file.contentType.startsWith('video/') ? 'Play' : 'Open'}
          </button>
          <button
            onclick="copyToClipboard('${file.url}')"
            class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300"
            id="copy-${file.key}"
          >
            Copy URL
          </button>
        </div>
      </div>
    `).join('');

    filesList.innerHTML = `
      <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
        ${filesHtml}
      </div>
    `;
  }

  function renderEmptyState() {
    if (!filesList) return;
    
    filesList.innerHTML = `
      <div class="text-center py-12 text-gray-500">
        <div class="text-4xl mb-4">üìÇ</div>
        <p>No files uploaded yet</p>
        <p class="text-sm">Upload your first file to get started</p>
      </div>
    `;
  }

  // Custom upload handler for signed URL approach
  uppy.on('file-added', async (file: any) => {
    try {
      showStatus('Starting upload...', 'info');
      
      let result;
      
      // Check file size and choose upload method
      if (file.data.size > 100 * 1024 * 1024) {
        // Large file - use multipart upload
        console.log('Large file detected, using multipart upload');
        const { uploadFileMultipart } = await import('../utils/file-api.js');
        result = await uploadFileMultipart(file.data, (progress: any) => {
          console.log(`Multipart upload progress: ${progress.percent.toFixed(1)}%`);
        });
      } else {
        // Small file - use regular upload
        result = await uppyR2S3Uploader.uploadFile(file.data, {
          onProgress: (progress) => {
            console.log(`Upload progress: ${progress.percent.toFixed(1)}%`);
          },
        });
      }

      if (result.success) {
        showStatus('File uploaded successfully!', 'success');
        loadFiles(); // Refresh file list
        // Remove the file from Uppy's state
        uppy.removeFile(file.id);
      } else {
        showStatus(`Upload failed: ${result.error}`, 'error');
        // Remove the file from Uppy's state
        uppy.removeFile(file.id);
      }
    } catch (error) {
      showStatus(`Upload failed: ${error instanceof Error ? error.message : 'Unknown error'}`, 'error');
      // Remove the file from Uppy's state
      uppy.removeFile(file.id);
    }
  });

  // Handle upload event to prevent errors
  uppy.on('upload', (data: any) => {
    console.log('Uppy upload event triggered - handling manually');
    // Since we handle uploads in file-added, we just need to prevent errors
    // The upload will be handled by our custom file-added handler
  });

  // Also handle upload-error to prevent unhandled errors
  uppy.on('upload-error', (file: any, error: any, response: any) => {
    console.log('Uppy upload error:', error);
    // Don't do anything - we handle errors in our custom upload process
  });

  async function handleDelete(key: string, filename: string) {
    if (!confirm(`Are you sure you want to delete "${filename}"?`)) return;

    try {
      const response = await deleteFile(key);
      if (response.success) {
        showStatus('File deleted successfully!', 'success');
        await loadFiles();
      } else {
        showStatus(response.error || 'Failed to delete file', 'error');
      }
    } catch (error) {
      showStatus('Failed to delete file', 'error');
    }
  }

  async function copyToClipboard(url: string) {
    try {
      await navigator.clipboard.writeText(url);
      showStatus('URL copied to clipboard!', 'success');
      
      const button = document.getElementById(`copy-${url.split('/').pop()}`);
      if (button) {
        button.textContent = 'Copied!';
        button.className = 'px-3 py-1 text-sm bg-green-600 text-white rounded';
        setTimeout(() => {
          button.textContent = 'Copy URL';
          button.className = 'px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300';
        }, 2000);
      }
    } catch (error) {
      showStatus('Failed to copy URL', 'error');
    }
  }

  function openFile(url: string, filename?: string, contentType?: string) {
    // Check if this is a video file
    if (contentType && contentType.startsWith('video/')) {
      openVideoModal(url, filename || 'Video');
    } else {
      window.open(url, '_blank');
    }
  }

  function openVideoModal(videoUrl: string, title: string) {
    if (!videoModal || !videoPlayer || !videoTitle) return;
    
    // Set video source and title
    videoPlayer.src = videoUrl;
    videoTitle.textContent = title;
    
    // Show modal
    videoModal.classList.remove('hidden');
    
    // Load video metadata
    videoPlayer.load();
  }

  function closeVideoModal() {
    if (!videoModal || !videoPlayer) return;
    
    // Pause and clear video
    videoPlayer.pause();
    videoPlayer.src = '';
    
    // Hide modal
    videoModal.classList.add('hidden');
  }

  // Close modal when clicking outside
  videoModal?.addEventListener('click', (e) => {
    if (e.target === videoModal) {
      closeVideoModal();
    }
  });

  // Close modal with Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !videoModal?.classList.contains('hidden')) {
      closeVideoModal();
    }
  });

  // View mode functions
  function switchViewMode(mode: 'table' | 'grid') {
    currentViewMode = mode;
    
    // Update button styles
    if (mode === 'table') {
      tableViewBtn?.classList.add('bg-blue-600', 'text-white');
      tableViewBtn?.classList.remove('text-gray-600');
      gridViewBtn?.classList.remove('bg-blue-600', 'text-white');
      gridViewBtn?.classList.add('text-gray-600');
    } else {
      gridViewBtn?.classList.add('bg-blue-600', 'text-white');
      gridViewBtn?.classList.remove('text-gray-600');
      tableViewBtn?.classList.remove('bg-blue-600', 'text-white');
      tableViewBtn?.classList.add('text-gray-600');
    }
    
    // Re-render files with new view mode
    renderFiles(currentFiles);
  }

  // Selection functions
  function toggleFileSelection(key: string) {
    if (selectedFiles.has(key)) {
      selectedFiles.delete(key);
    } else {
      selectedFiles.add(key);
    }
    updateBatchActions();
  }

  function toggleSelectAll(checkbox: HTMLInputElement) {
    const fileCheckboxes = document.querySelectorAll('.file-checkbox') as NodeListOf<HTMLInputElement>;
    
    fileCheckboxes.forEach(cb => {
      cb.checked = checkbox.checked;
      if (checkbox.checked) {
        selectedFiles.add(cb.dataset.key!);
      } else {
        selectedFiles.delete(cb.dataset.key!);
      }
    });
    
    updateBatchActions();
  }

  function selectAllFiles() {
    selectedFiles.clear();
    currentFiles.forEach(file => selectedFiles.add(file.key));
    renderFiles(currentFiles);
    updateBatchActions();
  }

  function deselectAllFiles() {
    selectedFiles.clear();
    renderFiles(currentFiles);
    updateBatchActions();
  }

  function updateBatchActions() {
    if (!batchActions || !selectedCount) return;
    
    if (selectedFiles.size > 0) {
      batchActions.classList.remove('hidden');
      selectedCount.textContent = `${selectedFiles.size} file${selectedFiles.size === 1 ? '' : 's'} selected`;
    } else {
      batchActions.classList.add('hidden');
    }
  }

  async function deleteSelectedFiles() {
    if (selectedFiles.size === 0) return;
    
    const fileNames = currentFiles
      .filter(file => selectedFiles.has(file.key))
      .map(file => file.filename)
      .join(', ');
    
    if (!confirm(`Are you sure you want to delete ${selectedFiles.size} file${selectedFiles.size === 1 ? '' : 's'}?\n\n${fileNames}`)) {
      return;
    }

    showStatus(`Deleting ${selectedFiles.size} file${selectedFiles.size === 1 ? '' : 's'}...`, 'info');
    
    const deletePromises = Array.from(selectedFiles).map(key => deleteFile(key));
    
    try {
      await Promise.all(deletePromises);
      showStatus(`Successfully deleted ${selectedFiles.size} file${selectedFiles.size === 1 ? '' : 's'}!`, 'success');
      selectedFiles.clear();
      await loadFiles(); // Refresh the file list
    } catch (error) {
      showStatus(`Failed to delete some files`, 'error');
      console.error('Batch delete error:', error);
    }
  }

  // Initialize view mode
  switchViewMode('grid');

  // Make functions globally available for onclick handlers
  (window as any).handleDelete = handleDelete;
  (window as any).copyToClipboard = copyToClipboard;
  (window as any).openFile = openFile;
  (window as any).closeVideoModal = closeVideoModal;
  (window as any).switchViewMode = switchViewMode;
  (window as any).toggleFileSelection = toggleFileSelection;
  (window as any).toggleSelectAll = toggleSelectAll;
  (window as any).selectAllFiles = selectAllFiles;
  (window as any).deselectAllFiles = deselectAllFiles;
  (window as any).deleteSelectedFiles = deleteSelectedFiles;
</script>
